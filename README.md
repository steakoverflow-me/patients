# Health Samurai test application

Доступно по ссылке: http://94.130.151.204:8080

Приложение крутится на [Hetzner](https://www.hetzner.com). База данных на [ElephantSQL](https://www.elephantsql.com). И там и там инстансы самого начального уровня, так что скорость работы невысока. Некоторые _безобидные_ варнинги в консоли оставлены сознательно, чтобы не тратить время.

# Стэк
### Бэкэнд (Clojure)
- Ring
- Compojure
- JDBC
### Фронтэнд (Clojurescript)
- Reagent
- Tailwind CSS
- ajax.core
### Тесты
- clojure.test
- io.zonky.test/embedded-postgres 
- webdriver (для интеграционного тестирования)

По возможности для работы с датами используется кроссплатформенная библиотека **cljc.java-time**. Также кросплатформенно выполнена валидация в **patients.validation**.

# Разработка
Разработка велась преимущественно в **Emacs**. В качестве системы сборки используется **Leiningen**. Во время разработки использовалась локальная база данных в докере. Значения переменных окружения по умолчанию рассчитаны именно на такое применение. С миграциями заморачиваться не стал. Просто проверка правильности структуры при запуске. Если проверка не пройдена (например база пустая), то всё сносится и заново создаются пустые таблицы и ключи. В случае необходимости можно раскомментировать строку в конце **patients.app**, чтобы заполнить базу тестовым датасэтом.

### Переменные окружения
|Имя|Описание|
|----|------|
|DB_USER|Имя юзера в PostgreSQL|
|DB_PASSWORD|Пароль|
|DB_HOST|Хост сервера базы данных|
|DB_PORT|Порт|
|DB_NAME|Имя базы данных|

# Тестирование
Основным раннером выбран **eftest**. Для тестирования создано два алиаса:
- **lein unit-tests**: юнит-тесты с применением **Cloverage**. К стопроцентному покрытию не стремился сознательно.
- **lein integration-tests**: интеграционные тесты с применением **Selenium Webdriver**
- **lein test-all**: последовательно запускает сначала юнит-тесты, затем интеграционные

Для интеграционных тестов необходимо установить в систему **Google Chrome** и [**ChromeDriver**](https://chromedriver.chromium.org). Причём важно установить нужные версии. Для последнего драйвера версия браузера должна быть **92**!

Одновременный запуск **patients.db-test** и **patients.integration.test** оказался нетривиальной задачей, так как **EmbeddedPostgres** выдаёт всем одну и ту же базу данных несмотря на варианты использования фикстур. Не стал надолго закапываться в проблему и разделил запуски.

Также интеграционные тесты в редких случаях заканчиваются неудачей по причине нестабильного поведения бразера. Не имею достаточного опыта в этой сфере, чтобы быстро решить эту проблему самостоятельно.

### Переменные окружения
|Имя|Описание|
|----|------|
|TEST_SLEEP|Время ожидания срабатывания запроса и отрисовки в миллисекундах при интеграционном тестировании (по умолчанию 5000)|
|TEST_NOT_HEADLESS|Любое значение в этой переменной вызовет визуальное отображение происходящего в браузере. По умолчанию запускается только движок и всё действие остаётся "за кадром"|
|TEST_CHROMEDRIVER_BINARY|Путь к бинарнику вебдрайвера|
|TEST_CHROME_BINARY|Путь к бинарнику Chrome|

# Деплой
Для деплоя используется CI/CD пайплайн в **GitHub Actions**. Код при коммите в ветку **deploy** проходит юнит-тестирование, собирается в uberjar и отправляется на линукс-сервер, где подразумеваются предустановленными **Java** и **Supervisor**. Интеграционное тестирование в этой среде в разумные сроки настроить не удалось.
